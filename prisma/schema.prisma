// Prisma Schema for EpicGPT Discord Bot
// Uses SQLite for development, PostgreSQL for production

generator client {
  provider = "prisma-client-js"
}

// Use sqlite for local development, postgresql for production
// Set DATABASE_URL accordingly:
// - SQLite: file:./dev.db
// - PostgreSQL: postgresql://user:password@host:5432/epicgpt?schema=public
// Note: In Prisma 7, connection URLs are configured in prisma.config.ts
datasource db {
  provider = "postgresql"
}

// Guild configuration - stores vector store ID and settings per guild
model GuildConfig {
  id               String   @id // Discord guild ID
  vectorStoreId    String?  // OpenAI vector store ID (created on first KB add)
  adminRoleId      String?  // Optional admin role override
  webSearchEnabled Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  knowledgeItems      KnowledgeItem[]
  requestLogs         RequestLog[]
  conversationSessions ConversationSession[]
}

// Knowledge base items - files and URLs ingested into the vector store
model KnowledgeItem {
  id                     String   @id @default(uuid())
  guildId                String
  kind                   String   // "FILE" | "URL"
  title                  String
  sourceUrl              String?
  openaiFileId           String   // OpenAI Files API file ID
  vectorStoreFileId      String   // Vector store file attachment ID
  contentHash            String   // SHA-256 for deduplication
  createdByDiscordUserId String
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  guild GuildConfig @relation(fields: [guildId], references: [id], onDelete: Cascade)

  @@index([guildId])
  @@index([contentHash])
}

// Request logs - tracks command usage and tool calls
model RequestLog {
  id             String   @id @default(uuid())
  guildId        String
  userId         String
  command        String   // "chat" | "search"
  usedFileSearch Boolean  @default(false)
  usedWebSearch  Boolean  @default(false)
  toolCalls      Json?    // Array of tool call results
  error          String?
  createdAt      DateTime @default(now())

  guild GuildConfig @relation(fields: [guildId], references: [id], onDelete: Cascade)

  @@index([guildId, userId])
  @@index([createdAt])
}

// Conversation sessions - stores message history per user/channel
model ConversationSession {
  id        String   @id @default(uuid())
  guildId   String
  userId    String
  channelId String
  messages  Json     // Array of {role, content}
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  expiresAt DateTime // TTL: 1 hour from last activity

  guild GuildConfig @relation(fields: [guildId], references: [id], onDelete: Cascade)

  @@unique([guildId, userId, channelId])
  @@index([expiresAt])
}
